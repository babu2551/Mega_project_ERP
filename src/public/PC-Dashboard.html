<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PIMR Dashboard - Final Fix</title>

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

  <style>
    :root {
      --primary-blue: #1e3a8a;
      --bg-color: #f0f2f5;
      --card-bg: #ffffff;
      --shadow-card: 0 8px 25px rgba(0, 0, 0, 0.08);
      --shadow-hover: 0 20px 40px rgba(30, 58, 138, 0.25);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Roboto", sans-serif;
    }

    body {
      background-color: var(--bg-color);
    }


    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 30px;
      background: #fff;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left,
    .header-right {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .header-left {
      justify-content: flex-start;
    }

    .header-left img {
      height: 50px;
      width: 100px;
    }

    .header-right {
      justify-content: flex-end;
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: bold;
      color: var(--primary-blue);
      font-size: 1.2rem;
    }

    .header-title {
      flex: 2;
      text-align: center;
      font-size: 1.4rem;
      font-weight: 800;
      color: black;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .year-badge {
      font-weight: bold;
      color: #333;
      margin-right: 15px;
    }

    .icon-btn {
      background: none;
      border: 1px solid #eee;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      cursor: pointer;
      color: #555;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: 0.3s;
    }

    .icon-btn:hover {
      background: #f0f0f0;
    }

    .user-profile {
      text-align: center;
      font-size: 0.75rem;
      color: #555;
    }

    .user-avatar {
      width: 30px;
      height: 30px;
      background: #e0e0e0;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 2px auto;
    }

    .logout-btn {
      background: rgba(251, 248, 248, 0.25);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.25);
      padding: 10px 22px;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
      transition: all 0.3s ease;
    }


    .dashboard-container {
      padding: 40px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .dashboard-main-title {
      text-align: center;
      font-size: 2.2rem;
      font-weight: 800;
      color: var(--primary-blue);
      margin-bottom: 35px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 30px;
    }

    @media (max-width: 1200px) {
      .grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 600px) {
      .grid {
        grid-template-columns: 1fr;
      }

      header {
        flex-direction: column;
        gap: 10px;
      }

      .header-title {
        font-size: 1.1rem;
        text-align: center;
      }
    }


    .card {
      background-color: var(--card-bg);
      border-radius: 18px;

      padding: 25px 20px;
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
      height: 270px;

      box-shadow: var(--shadow-card);
      border: 1px solid #eef2f7;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .card:hover {
      transform: translateY(-10px);

      background-color: #fff;
      box-shadow: var(--shadow-hover);

      border-color: #e0e0e0;
    }

    .card h3 {
      font-size: 0.95rem;
      color: #000;
      font-weight: 700;
      margin-bottom: 10px;
      min-height: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2;
    }


    .icon-container {
      flex-grow: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      margin-bottom: 15px;
    }

    .icon-container i {
      font-size: 4rem;

      color: #333;

      transition: all 0.3s ease;


      -webkit-text-stroke: 1px transparent;
    }


    .card:hover .icon-container i {
      color: var(--primary-blue);
      transform: scale(1.1);
    }

    .view-btn {
      background-color: var(--primary-blue);
      color: white;
      border: none;
      padding: 12px 0;
      width: 85%;
      border-radius: 12px;
      font-size: 0.9rem;
      font-weight: 600;

      cursor: pointer;
      transition: background 0.3s, transform 0.2s;
      z-index: 2;
      box-shadow: 0 5px 15px rgba(30, 58, 138, 0.2);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .view-btn:hover {
      background-color: #172554;
    }
  </style>
</head>

<body>
  <header>
    <div class="header-left">
      <div class="logo-section">
        <img src="../images/logo.png" alt="logo" /> <span>PIMR</span>
      </div>
    </div>

    <div class="header-right">
      <span class="year-badge">2025-2026</span>

      <button class="icon-btn"><i class="fas fa-bell"></i></button>
      <div class="user-profile">
        <div class="user-avatar"><i class="fas fa-user"></i></div>
        <span>hello! faculty</span>
      </div>
      <button class="logout-btn">
        <i class="fas fa-sign-out-alt"></i> LOG OUT
      </button>
    </div>
  </header>

  <main class="dashboard-container">
    <h1 class="dashboard-main-title">PROGRAM COORDINATOR</h1>
    <div class="grid" id="cardGrid"></div>
  </main>

  <script>
    // Dashboard tiles data
    const dashboardData = [
      {
        title: "My Programme Submissions<br>(PC)",
        icon: "fa-file-lines",
        type: "pc-entries",
      },
      {
        title: "Value-Added Courses<br>(VAC)",
        icon: "fa-file-signature",
        type: "vac-entries",
      },
      { title: "E-Content Development", icon: "fa-video", type: "e-content" },
      {
        title: "Capacity Development & Skill<br>Enhancement Activities",
        icon: "fa-brain",
        type: "e-capacity",
      },
      {
        title: "Teaching, Learning<br>& Pedagogy Innovations",
        icon: "fa-lightbulb",
        type: "teaching",
      },
      {
        title: "Learners' Support:<br>Advanced & Slow Learners",
        icon: "fa-layer-group",
      },
      { title: "Library & Learning<br>Resources", icon: "fa-book-open" },
      { title: "Students Progression<br>Tracking", icon: "fa-chart-line" },
      { title: "Collaborations &<br>Partnerships", icon: "fa-handshake" },
      { title: "Governing Records", icon: "fa-folder-open" },
      { title: "Programme Structure &<br>Revisions", icon: "fa-sitemap" },
      {
        title: "Events, Counselling &<br>Career Development",
        icon: "fa-calendar-check",
      },
      {
        title: "Experiential / Participative /<br>Problem-Solving Components",
        icon: "fa-users-gear",
      },
    ];

    const gridContainer = document.getElementById("cardGrid");

    // Get query parameters for programme filtering
    const urlParams = new URLSearchParams(window.location.search);
    const selectedCode = urlParams.get("code") || "";
    const selectedName = urlParams.get("name") || "";
    const selectedProgramId = urlParams.get("programId") || urlParams.get("program_Id") || "";

    function createElementFromHTML(html) {
      const div = document.createElement("div");
      div.innerHTML = html.trim();
      return div.firstChild;
    }

    function formatDate(iso) {
      if (!iso) return "-";
      try {
        const d = new Date(iso);
        return d.toLocaleString();
      } catch (e) {
        return iso;
      }
    }

    function renderDashboard() {
      gridContainer.innerHTML = "";
      dashboardData.forEach((item, index) => {
        const card = document.createElement("div");
        card.classList.add("card");

        card.style.opacity = "0";
        card.style.animation = `fadeInUp 0.5s ease forwards ${index * 0.05}s`;

        card.innerHTML = `
                    <h3>${item.title}</h3>
                    <div class="icon-container">
                        <i class="fas ${item.icon}"></i>
                    </div>
                    <button class="view-btn">View Details</button>
                `;

        const btn = card.querySelector(".view-btn");
        btn.addEventListener("click", (ev) => {
          ev.stopPropagation();
          if (item.type === "vac-entries") showVacModal();
          else if (item.type === "pc-entries") showPcModal();
          else if (
            item.type === "e-content" ||
            item.type === "e-capacity" ||
            item.type === "teaching"
          )
            showOtherModal(item.type);
          else alert("View details for: " + item.title.replace(/<br>/g, " "));
        });

        gridContainer.appendChild(card);
      });
    }


    async function showPcModal() {
      const token = (() => {
        try {
          return localStorage.getItem("token");
        } catch (e) {
          return null;
        }
      })();
      if (!token) {
        alert("Login required");
        return;
      }

      let entries = [];
      try {
        const res = await fetch(
          "/api/pc/entries" + (selectedProgramId ? "?programId=" + encodeURIComponent(selectedProgramId) : ""),
          {
            headers: { Authorization: "Bearer " + token },
          }
        );
        if (!res.ok) {
          const j = await res.json().catch(() => ({}));
          alert(j.error || "Failed to load PC entries");
          return;
        }
        entries = await res.json();
      } catch (err) {
        console.error(err);
        alert("Server error");
        return;
      }

      // Apply query parameter filters
      if (selectedCode)
        entries = entries.filter((e) => e.programmeCode === selectedCode);
      if (selectedName)
        entries = entries.filter((e) => e.programmeName === selectedName);

      const backdrop = document.createElement("div");
      backdrop.className = "vac-modal-backdrop";
      const modal = document.createElement("div");
      modal.className = "vac-modal";
      const titleSuffix = (selectedCode ? ` (${selectedCode})` : "") + (selectedProgramId ? ` [ID: ${selectedProgramId}]` : "");
      modal.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
            <h2>My Programme Submissions${titleSuffix}</h2>
            <div><button id="pcClose" style="background:#ddd;border:none;padding:8px 10px;border-radius:6px;cursor:pointer">Close</button></div>
          </div><div id="pcList" style="margin-top:12px"></div>`;
      backdrop.appendChild(modal);
      document.body.appendChild(backdrop);

      const list = modal.querySelector("#pcList");
      if (!entries || entries.length === 0)
        list.innerHTML =
          '<div style="padding:12px;color:#666">No programme submissions found.</div>';
      entries.forEach((e) => {
        const item = document.createElement("div");
        item.className = "vac-item";
        const left = document.createElement("div");
        left.className = "meta";
        left.innerHTML = `<strong>Entry:</strong> ${e._id || e.id || ""
          }<br><small>Created: ${new Date(
            e.createdAt || e.createdAt
          ).toLocaleString()}</small><br><small>Programme: ${e.programmeCode || ""
          }</small><br><small>Linked courses: ${e.linkedCoursesCount || 0
          }</small>`;
        const right = document.createElement("div");
        right.className = "actions";
        const view = document.createElement("button");
        view.textContent = "View";
        view.style.padding = "6px 10px";
        view.style.cursor = "pointer";
        view.addEventListener("click", () =>
          openPcDetails(e._id || e.id, modal)
        );
        right.appendChild(view);

        // Add download button if file exists
        if (e.uploadedFile) {
          const downloadFile = document.createElement("button");
          downloadFile.textContent = "Download File";
          downloadFile.style.padding = "6px 10px";
          downloadFile.style.cursor = "pointer";
          downloadFile.style.marginLeft = "8px";
          downloadFile.addEventListener("click", () => {
            const fileUrl = `/uploads/${e.uploadedFile}`;
            const a = document.createElement("a");
            a.href = fileUrl;
            a.download = e.uploadedFile;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
          });
          right.appendChild(downloadFile);
        }

        item.appendChild(left);
        item.appendChild(right);
        list.appendChild(item);
      });

      modal
        .querySelector("#pcClose")
        .addEventListener("click", () => backdrop.remove());
    }

    async function openPcDetails(id, parentModal) {
      const token = (() => {
        try {
          return localStorage.getItem("token");
        } catch (e) {
          return null;
        }
      })();
      if (!token) return alert("Not authenticated");
      try {
        const res = await fetch(
          "/api/pc/entries" + (selectedProgramId ? "?programId=" + encodeURIComponent(selectedProgramId) : ""),
          {
            headers: { Authorization: "Bearer " + token },
          }
        );
        if (!res.ok) {
          const j = await res.json().catch(() => ({}));
          return alert(j.error || "Failed");
        }
        const entries = await res.json();
        const entry = entries.find((x) => (x._id || x.id) == id);
        if (!entry) return alert("Entry not found");
        let detailsPanel = parentModal.querySelector(".entry-details-pc");
        if (!detailsPanel) {
          detailsPanel = document.createElement("div");
          detailsPanel.className = "entry-details-pc";
          detailsPanel.style.marginTop = "12px";
          detailsPanel.style.paddingTop = "12px";
          detailsPanel.style.borderTop = "1px solid #eee";
          parentModal.appendChild(detailsPanel);
        }
        detailsPanel.innerHTML = `<h3>PC Entry ${entry._id || entry.id}</h3>
            <div><strong>Programme:</strong> ${entry.programmeCode || ""}</div>
            <div><strong>Academic Year:</strong> ${entry.academicYear || ""
          }</div>
            <div style="margin-top:8px"><strong>Linked Courses Count:</strong> ${entry.linkedCoursesCount || 0
          }</div>`;
      } catch (err) {
        console.error(err);
        alert("Error loading entry");
      }
    }

    // Insert animation keyframes
    const styleSheet = document.createElement("style");
    styleSheet.innerText = `
            @keyframes fadeInUp {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
            /* Modal styles for VAC list */
            .vac-modal-backdrop { position: fixed; inset:0; background: rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:9999; }
            .vac-modal { background: #fff; width: 90%; max-width: 900px; border-radius: 12px; padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); max-height: 80vh; overflow:auto; }
            .vac-modal h2 { margin-bottom: 8px; font-size:1.1rem; }
            .vac-list { margin-top:12px; }
            .vac-item { border:1px solid #eef2f7; padding:12px; border-radius:8px; margin-bottom:10px; display:flex; justify-content:space-between; gap:12px; align-items:center; }
            .vac-item .meta { font-size:0.9rem; color:#333 }
            .vac-item .actions button { margin-left:8px }
        `;
    document.head.appendChild(styleSheet);

    renderDashboard();

    // VAC modal implementation
    async function showVacModal() {
      const token = (() => {
        try {
          return localStorage.getItem("token");
        } catch (e) {
          return null;
        }
      })();
      if (!token) {
        alert("You must be logged in to view VAC entries.");
        return;
      }

      let entries = [];
      try {
        const res = await fetch("/api/vac/entries", {
          headers: { Authorization: "Bearer " + token },
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          alert(err.error || "Failed to load VAC entries");
          return;
        }
        entries = await res.json();
      } catch (err) {
        console.error(err);
        alert("Server error while loading VAC entries");
        return;
      }
      // prepend any locally-saved VAC entries (saved by the user when they choose not to persist to DB)
      try {
        const local = JSON.parse(localStorage.getItem('vac:local') || '[]');
        if (Array.isArray(local) && local.length) {
          entries = [...local, ...entries];
        }
        console.debug('VAC entries loaded, total:', entries.length);
        const backdrop = document.createElement('div');
        backdrop.className = 'vac-modal-backdrop';
        const modal = document.createElement('div');
        modal.className = 'vac-modal';
        modal.innerHTML = `<div style="display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;">
          <h2>VAC Entries</h2>
          <div style="display:flex;
          gap:8px;
          align-items:center;">
            <button id="vacDownloadAll" style="background:#1e3a8a;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer">Download All (admin)</button>
            <button id="vacClose" style="background:#ddd;border:none;padding:8px 10px;border-radius:6px;cursor:pointer">Close</button>
          </div>
        </div>
        <div class="vac-list" id="vacList">${entries.length ? '' : '<div style="padding:12px;color:#666">No entries found.</div>'}</div>`;

        backdrop.appendChild(modal);
        document.body.appendChild(backdrop);

        const vacList = modal.querySelector('#vacList');

        entries.forEach((e) => {
          const item = document.createElement("div");
          item.className = "vac-item";
          const left = document.createElement("div");
          left.className = "meta";
          const isLocal = !!(e.local || (e.id && String(e.id).startsWith && String(e.id).startsWith('local-')));
          const displayId = (e.id || e._id || '') + (isLocal ? ' (local)' : '');
          left.innerHTML = `<strong>Entry:</strong> ${displayId} <br><small>Created: ${formatDate(e.createdAt)}</small> <br><small>Courses: ${Array.isArray(e.courses) ? e.courses.length : 0}</small> <br><small>Sent: ${e.sentToCoordinator ? "Yes" : "No"}</small>`;

          const right = document.createElement("div");
          right.className = "actions";
          const viewBtn = document.createElement("button");
          viewBtn.textContent = "View";
          viewBtn.style.padding = "6px 10px";
          viewBtn.style.borderRadius = "6px";
          viewBtn.style.cursor = "pointer";
          viewBtn.addEventListener("click", () =>
            openEntryDetails(e.id, modal)
          );

          const downloadBtn = document.createElement("button");
          downloadBtn.textContent = isLocal ? "Download CSV (local)" : "Download CSV";
          downloadBtn.style.padding = "6px 10px";
          downloadBtn.style.borderRadius = "6px";
          downloadBtn.style.cursor = "pointer";
          if (isLocal) {
            downloadBtn.addEventListener('click', () => {
              // build per-entry CSV from local data
              const rows = [];
              if (Array.isArray(e.courses) && e.courses.length) {
                rows.push('section,entryId,createdAt,index,courseName,courseCode,duration,timesOffered,studentsEnrolled,studentsCompleted,brochureLink,coordinator');
                e.courses.forEach((c, i) => {
                  const row = ['VAC', e.id || '', e.createdAt || '', i + 1, c.courseName || '', c.courseCode || '', c.duration || '', c.timesOffered || '', c.studentsEnrolled || '', c.studentsCompleted || '', c.brochureLink || '', c.coordinator || ''];
                  rows.push(row.map(v => typeof v === 'object' ? JSON.stringify(v) : String(v)).map(v => v.includes(',') || v.includes('\n') || v.includes('"') ? '"' + v.replace(/"/g, '""') + '"' : v).join(','));
                });
              } else {
                rows.push('section,entryId,createdAt,note');
                rows.push(['VAC', e.id || '', e.createdAt || '', 'no courses'].map(v => typeof v === 'object' ? JSON.stringify(v) : String(v)).map(v => v.includes(',') || v.includes('\n') || v.includes('"') ? '"' + v.replace(/"/g, '""') + '"' : v).join(','));
              }
              const csv = rows.join('\n');
              const blob = new Blob([csv], { type: 'text/csv' });
              const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `vac_entry_${e.id || 'local'}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
            });
          } else {
            downloadBtn.addEventListener("click", () =>
              downloadEntryCSV(e.id, token)
            );
          }

          right.appendChild(viewBtn);
          right.appendChild(downloadBtn);

          // Add download file button if file exists
          if (e.uploadedFile) {
            const downloadFileBtn = document.createElement("button");
            downloadFileBtn.textContent = "Download File";
            downloadFileBtn.style.padding = "6px 10px";
            downloadFileBtn.style.borderRadius = "6px";
            downloadFileBtn.style.cursor = "pointer";
            downloadFileBtn.style.marginLeft = "8px";
            downloadFileBtn.addEventListener("click", () => {
              const fileUrl = `/uploads/${e.uploadedFile}`;
              const a = document.createElement("a");
              a.href = fileUrl;
              a.download = e.uploadedFile;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
            });
            right.appendChild(downloadFileBtn);
          }

          item.appendChild(left);
          item.appendChild(right);
          vacList.appendChild(item);
        });

        modal.querySelector("#vacClose").addEventListener("click", () => {
          backdrop.remove();
        });

        modal
          .querySelector("#vacDownloadAll")
          .addEventListener("click", async () => {
            // download combined CSV of server + local entries (if any)
            try {
              const local = JSON.parse(localStorage.getItem('vac:local') || '[]');
              // if no local entries, fall back to server download (admin-only)
              if (!local || local.length === 0) {
                const r = await fetch("/api/vac/entries/download", {
                  headers: { Authorization: "Bearer " + token },
                });
                if (!r.ok) {
                  const j = await r.json().catch(() => ({}));
                  alert(j.error || "Failed to download");
                  return;
                }
                const blob = await r.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "vac_entries_all.csv";
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
                return;
              };

              // combine local + server entries (entries variable is in scope)
              const combined = [...local, ...(entries || [])];
              // produce a simple CSV: id,createdAt,coursesCount,coursesJSON
              const rows = combined.map((en) => ({
                id: en.id || en._id || '',
                createdAt: en.createdAt || new Date().toISOString(),
                coursesCount: Array.isArray(en.courses) ? en.courses.length : 0,
                courses: JSON.stringify(en.courses || [])
              }));
              const keys = ['id', 'createdAt', 'coursesCount', 'courses'];
              const csv = [keys.join(','), ...rows.map(r => keys.map(k => {
                const v = r[k];
                if (v === null || v === undefined) return '';
                const s = typeof v === 'object' ? JSON.stringify(v) : String(v);
                return s.includes(',') || s.includes('\n') || s.includes('"') ? '"' + s.replace(/"/g, '""') + '"' : s;
              }).join(','))].join('\n');

              const blob = new Blob([csv], { type: 'text/csv' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = 'vac_entries_combined.csv';
              document.body.appendChild(a); a.click();
              a.remove(); URL.revokeObjectURL(url);
            }
            catch (err) {
              console.error(err);
              alert("Failed to download");
            }
          });
      } catch (e) { console.warn('Failed to prepare VAC modal', e); }
    }

    async function openEntryDetails(id, parentModal) {
      // if this is a local entry (not saved to DB), load it from localStorage
      if (String(id || '').startsWith('local-')) {
        try {
          const local = JSON.parse(localStorage.getItem('vac:local') || '[]');
          const entry = (local || []).find((x) => x.id === id);
          if (!entry) return alert('Local entry not found');

          let detailsPanel = parentModal.querySelector('.entry-details');
          if (!detailsPanel) {
            detailsPanel = document.createElement('div');
            detailsPanel.className = 'entry-details';
            detailsPanel.style.marginTop = '12px';
            detailsPanel.style.paddingTop = '12px';
            detailsPanel.style.borderTop = '1px solid #eee';
            parentModal.appendChild(detailsPanel);
          };
          detailsPanel.innerHTML = `<h3>Local VAC Entry ${entry.id}</h3>
              <div><strong>Created:</strong> ${formatDate(entry.createdAt)}</div>
              <div style="margin-top:8px"><strong>Courses:</strong></div>
              <div id="coursesList" style="margin-top:6px"></div>`;

          const coursesList = detailsPanel.querySelector('#coursesList');
          coursesList.innerHTML = '';
          if (Array.isArray(entry.courses) && entry.courses.length) {
            entry.courses.forEach((c, idx) => {
              const div = document.createElement('div');
              div.style.padding = '8px';
              div.style.border = '1px solid #f0f0f0';
              div.style.borderRadius = '8px';
              div.style.marginBottom = '8px';
              div.innerHTML = `<strong>${idx + 1}. ${c.courseName || 'Untitled'}</strong> (<em>${c.courseCode || ''}</em>)<br>
                  Duration: ${c.duration || ''} | Times offered: ${c.timesOffered || ''}<br>
                  Students enrolled: ${c.studentsEnrolled || ''} | Completed: ${c.studentsCompleted || ''}<br>
                  Coordinator: ${c.coordinator || ''} | Brochure: ${c.brochureLink || ''}`;
              coursesList.appendChild(div);
            });
          } else {
            coursesList.innerHTML = '<div style="color:#666">No courses in this entry</div>';
          }
          return;
        } catch (err) {
          console.error(err);
          alert('Error loading local entry');
          return;
        }
      }

      const token = (() => {
        try {
          return localStorage.getItem("token");
        } catch (e) {
          return null;
        }
      })();
      if (!token) return alert("Not authenticated");
      try {
        const res = await fetch("/api/vac/entries/" + id, {
          headers: { Authorization: "Bearer " + token },
        });
        if (!res.ok) {
          const j = await res.json().catch(() => ({}));
          return alert(j.error || "Failed to load entry");
        }
        const entry = await res.json();

        // show entry details in a sub-panel inside parentModal
        let detailsPanel = parentModal.querySelector(".entry-details");
        if (!detailsPanel) {
          detailsPanel = document.createElement("div");
          detailsPanel.className = "entry-details";
          detailsPanel.style.marginTop = "12px";
          detailsPanel.style.paddingTop = "12px";
          detailsPanel.style.borderTop = "1px solid #eee";
          parentModal.appendChild(detailsPanel);
        }

        detailsPanel.innerHTML = `<h3>Entry ${entry.id}</h3>
            <div><strong>Created:</strong> ${formatDate(entry.createdAt)}</div>
            <div style="margin-top:8px"><strong>Courses:</strong></div>
            <div id="coursesList" style="margin-top:6px"></div>
          `;

        const coursesList = detailsPanel.querySelector("#coursesList");
        coursesList.innerHTML = "";
        if (Array.isArray(entry.courses) && entry.courses.length) {
          entry.courses.forEach((c, idx) => {
            const div = document.createElement("div");
            div.style.padding = "8px";
            div.style.border = "1px solid #f0f0f0";
            div.style.borderRadius = "8px";
            div.style.marginBottom = "8px";
            div.innerHTML = `<strong>${idx + 1}. ${c.courseName || "Untitled"
              }</strong> (<em>${c.courseCode || ""}</em>)<br>
                Duration: ${c.duration || ""} | Times offered: ${c.timesOffered || ""
              }<br>
                Students enrolled: ${c.studentsEnrolled || ""} | Completed: ${c.studentsCompleted || ""
              }<br>
                Coordinator: ${c.coordinator || ""} | Brochure: ${c.brochureLink || ""
              }`;
            coursesList.appendChild(div);
          });
        } else {
          coursesList.innerHTML =
            '<div style="color:#666">No courses in this entry</div>';
        }
      } catch (err) {
        console.error(err);
        alert("Error loading entry");
      }
    }

    async function downloadEntryCSV(id, token) {
      try {
        const res = await fetch("/api/vac/entries/" + id + "/download", {
          headers: { Authorization: "Bearer " + token },
        });
        if (!res.ok) {
          const j = await res.json().catch(() => ({}));
          alert(j.error || "Failed to download");
          return;
        }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `vac_entry_${id}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (err) {
        console.error(err);
        alert("Failed to download CSV");
      }
    }

    // Generic modal for E-Content / Capacity / Teaching entries
    async function showOtherModal(type) {
      const token = (() => {
        try {
          return localStorage.getItem("token");
        } catch (e) {
          return null;
        }
      })();
      if (!token) {
        alert("Login required");
        return;
      }

      const mapping = {
        "e-content": "/api/econtent/entries",
        "e-capacity": "/api/capacity/entries",
        teaching: "/api/teaching/entries",
      };
      const baseEndpoint = mapping[type];
      if (!baseEndpoint) return alert("Unknown type");
      const endpoint = baseEndpoint + (selectedProgramId ? ("?programId=" + encodeURIComponent(selectedProgramId)) : "");

      let entries = [];
      try {
        const res = await fetch(endpoint, {
          headers: { Authorization: "Bearer " + token },
        });
        if (!res.ok) {
          const j = await res.json().catch(() => ({}));
          alert(j.error || "Failed to load entries");
          return;
        }
        entries = await res.json();
      } catch (err) {
        console.error(err);
        alert("Server error");
        return;
      }

      const backdrop = document.createElement("div");
      backdrop.className = "vac-modal-backdrop";
      const modal = document.createElement("div");
      modal.className = "vac-modal";
      const titleSuffix = selectedProgramId ? ` [ID: ${selectedProgramId}]` : "";
      modal.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;gap:12px;"><h2>${type
        .replace("-", " ")
        .toUpperCase()}${titleSuffix}</h2><div><button id="otherClose" style="background:#ddd;border:none;padding:8px 10px;border-radius:6px;cursor:pointer">Close</button></div></div><div id="otherList" style="margin-top:12px"></div>`;
      backdrop.appendChild(modal);
      document.body.appendChild(backdrop);

      const list = modal.querySelector("#otherList");
      if (!entries || entries.length === 0)
        list.innerHTML =
          '<div style="padding:12px;color:#666">No entries found.</div>';
      entries.forEach((e) => {
        const item = document.createElement("div");
        item.className = "vac-item";
        const left = document.createElement("div");
        left.className = "meta";
        left.innerHTML = `<strong>Entry:</strong> ${e.id || e._id || ""
          }<br><small>Created: ${formatDate(e.createdAt)}</small>`;
        const right = document.createElement("div");
        right.className = "actions";
        const view = document.createElement("button");
        view.textContent = "View";
        view.style.padding = "6px 10px";
        view.style.cursor = "pointer";
        view.addEventListener("click", async () => {
          try {
            const r = await fetch(baseEndpoint + "/" + (e.id || e._id), {
              headers: { Authorization: "Bearer " + token },
            });
            if (!r.ok) {
              const j = await r.json().catch(() => ({}));
              return alert(j.error || "Failed to load");
            }
            const doc = await r.json();
            let detailsPanel = modal.querySelector(".entry-details-other");
            if (!detailsPanel) {
              detailsPanel = document.createElement("div");
              detailsPanel.className = "entry-details-other";
              detailsPanel.style.marginTop = "12px";
              detailsPanel.style.paddingTop = "12px";
              detailsPanel.style.borderTop = "1px solid #eee";
              modal.appendChild(detailsPanel);
            }
            detailsPanel.innerHTML = `<h3>Entry ${doc.id || doc._id
              }</h3><pre style="white-space:pre-wrap;font-size:0.95rem">${JSON.stringify(
                doc,
                null,
                2
              )}</pre>`;
          } catch (err) {
            console.error(err);
            alert("Error loading entry");
          }
        });
        right.appendChild(view);
        if (e.uploadedFile) {
          const dl = document.createElement("button");
          dl.textContent = "Download File";
          dl.style.padding = "6px 10px";
          dl.style.marginLeft = "8px";
          dl.addEventListener("click", () => {
            const a = document.createElement("a");
            a.href = `/uploads/${e.uploadedFile}`;
            a.download = e.uploadedFile;
            document.body.appendChild(a);
            a.click();
            a.remove();
          });
          right.appendChild(dl);
        }
        item.appendChild(left);
        item.appendChild(right);
        list.appendChild(item);
      });

      modal
        .querySelector("#otherClose")
        .addEventListener("click", () => backdrop.remove());
    }
  </script>
</body>

</html>